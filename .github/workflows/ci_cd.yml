name: CI/CD - TPA Admin Auth & Gateway

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AUTH_IMAGE_NAME: tpa-admin-auth
  GATEWAY_IMAGE_NAME: tpa-admin-gateway
  DEPLOY_PATH: /home/nex3/app/tpa-admin-auth-api

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Build Docker Images
        run: |
          echo "ğŸ³ Building Docker Images with tag 'prod'..."
          
          # [ìˆ˜ì •] íŒŒì¼ëª… í•˜ì´í”ˆ(-) í™•ì¸: Dockerfile-auth
          # [ìˆ˜ì •] íƒœê·¸ prodë¡œ ê³ ì •
          docker build -t ${{ env.AUTH_IMAGE_NAME }}:prod -f Dockerfile-auth .
          
          # [ìˆ˜ì •] íŒŒì¼ëª… í•˜ì´í”ˆ(-) í™•ì¸: Dockerfile-gateway
          docker build -t ${{ env.GATEWAY_IMAGE_NAME }}:prod -f Dockerfile-gateway .

      - name: Prepare & Execute Deployment
        run: |
          mkdir -p ${{ env.DEPLOY_PATH }}
          
          cp docker-compose.yml ${{ env.DEPLOY_PATH }}/
          cp scripts/deploy.sh ${{ env.DEPLOY_PATH }}/
          chmod +x ${{ env.DEPLOY_PATH }}/deploy.sh
          
          # ë¬´ì¡°ê±´ prod í™˜ê²½ìœ¼ë¡œ ì‹¤í–‰
          cd ${{ env.DEPLOY_PATH }}
          ./deploy.sh prod

      - name: Cleanup Docker
        run: docker image prune -f